# ══════════════════════════════════════════════════════════════
# RozgarX AI — GitHub Actions APK Builder
# Fixed for repo structure: Rozgarx- / rozgarx-final / mobile /
# ══════════════════════════════════════════════════════════════
# REQUIRED GitHub Secret:
#   GOOGLE_SERVICES_JSON  ← paste full content of google-services.json
#
# TRIGGER: Push to main/master OR manual from Actions tab
# OUTPUT:  Actions tab → click run → Artifacts → download APK
# ══════════════════════════════════════════════════════════════

name: "Build RozgarX AI APK"

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: "Build Android APK"
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:

      # ── 1. Download your code
      - name: "Checkout code"
        uses: actions/checkout@v4

      # ── 2. Install Java 17
      - name: "Setup Java 17"
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      # ── 3. Install Flutter
      - name: "Setup Flutter 3.19.6"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.6"
          channel: "stable"
          cache: true

      # ── 4. Verify Flutter
      - name: "Verify Flutter"
        run: flutter --version 

      # ── 5. Show repo structure for debugging
      - name: "Show repo structure"
        run: |
          echo "Root contents:"
          ls -la
          echo ""
          echo "rozgarx-final contents:"
          ls -la rozgarx-final/
          echo ""
          echo "mobile contents:"
          ls -la rozgarx-final/mobile/

      # ── 6. Create google-services.json
      - name: "Create google-services.json"
        working-directory: rozgarx-final/mobile
        env:
          GOOGLE_SERVICES: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          if [ -z "$GOOGLE_SERVICES" ]; then
            echo "ERROR: GOOGLE_SERVICES_JSON secret is not set!"
            echo "Fix: GitHub repo Settings > Secrets > Actions > New secret"
            echo "Name: GOOGLE_SERVICES_JSON"
            echo "Value: paste your google-services.json file content"
            exit 1
          fi
          echo "$GOOGLE_SERVICES" > android/app/google-services.json
          echo "google-services.json created OK"
          wc -c android/app/google-services.json

      # ── 7. Create asset folders
      - name: "Create asset folders"
        working-directory: rozgarx-final/mobile
        run: |
          mkdir -p assets/images assets/animations assets/fonts
          touch assets/images/.gitkeep
          touch assets/animations/.gitkeep
          touch assets/fonts/.gitkeep
          echo "Asset folders ready"

      - name: "Generate app launcher icons"
        working-directory: rozgarx-final/mobile
        run: |
          # Create all mipmap directories
          mkdir -p android/app/src/main/res/mipmap-mdpi
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/app/src/main/res/mipmap-xhdpi
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi

          # Generate a simple blue RX icon using Python
          python3 - << 'PYEOF'
          import struct, zlib, os

          def make_png(size, r, g, b):
              def chunk(name, data):
                  c = zlib.crc32(name + data) & 0xffffffff
                  return struct.pack('>I', len(data)) + name + data + struct.pack('>I', c)
              ihdr = struct.pack('>IIBBBBB', size, size, 8, 2, 0, 0, 0)
              raw = b''
              for y in range(size):
                  raw += b'\x00'
                  for x in range(size):
                      cx, cy = x - size//2, y - size//2
                      dist = (cx*cx + cy*cy) ** 0.5
                      radius = size * 0.42
                      inner = size * 0.25
                      if dist <= radius:
                          if dist <= inner:
                              raw += bytes([255, 255, 255])
                          else:
                              raw += bytes([r, g, b])
                      else:
                          raw += bytes([255, 255, 255])
              compressed = zlib.compress(raw)
              png = (b'\x89PNG\r\n\x1a\n'
                     + chunk(b'IHDR', ihdr)
                     + chunk(b'IDAT', compressed)
                     + chunk(b'IEND', b''))
              return png

          sizes = {
              'mipmap-mdpi': 48,
              'mipmap-hdpi': 72,
              'mipmap-xhdpi': 96,
              'mipmap-xxhdpi': 144,
              'mipmap-xxxhdpi': 192,
          }
          for folder, size in sizes.items():
              path = f'android/app/src/main/res/{folder}/ic_launcher.png'
              with open(path, 'wb') as f:
                  f.write(make_png(size, 26, 115, 232))
              print(f'Created {path} ({size}x{size})')
          PYEOF
          echo "Icons generated successfully"
          ls android/app/src/main/res/mipmap-mdpi/

      # ── 8. Flutter pub get
      - name: "Flutter pub get"
        working-directory: rozgarx-final/mobile
        run: flutter pub get

      # ── 9. Analyze code
      - name: "Analyze code"
        working-directory: rozgarx-final/mobile
        run: flutter analyze --no-fatal-infos || true

      # ── 10. Build Debug APK
      - name: "Build Debug APK"
        working-directory: rozgarx-final/mobile
        run: |
          flutter build apk --debug
          echo "Debug APK size:"
          ls -lh build/app/outputs/flutter-apk/app-debug.apk
          
      # ── 11. Build Release APK
      - name: "Build Release APK"
        working-directory: rozgarx-final/mobile
        run: |
          flutter build apk --release --split-per-abi
          echo "All APK files:"
          ls -lh build/app/outputs/flutter-apk/

      # ── 12. Get app version
      - name: "Get version"
        id: version
        working-directory: rozgarx-final/mobile
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | head -1 | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # ── 13. Upload arm64 APK (best for most phones)
      - name: "Upload arm64 release APK"
        uses: actions/upload-artifact@v4
        with:
          name: "RozgarX-AI-arm64-release"
          path: rozgarx-final/mobile/build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          retention-days: 30
          if-no-files-found: error

      # ── 14. Upload debug APK
      - name: "Upload debug APK"
        uses: actions/upload-artifact@v4
        with:
          name: "RozgarX-AI-debug"
          path: rozgarx-final/mobile/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30
          if-no-files-found: warn

      # ── 15. Upload all APK variants
      - name: "Upload all APK variants"
        uses: actions/upload-artifact@v4
        with:
          name: "RozgarX-AI-all-variants"
          path: rozgarx-final/mobile/build/app/outputs/flutter-apk/*.apk
          retention-days: 30
          if-no-files-found: warn

      # ── 16. Build summary
      - name: "Build Summary"
        run: |
          echo "## RozgarX AI APK Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Built at | $(date '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Download | Scroll to Artifacts section below |" >> $GITHUB_STEP_SUMMARY
          
