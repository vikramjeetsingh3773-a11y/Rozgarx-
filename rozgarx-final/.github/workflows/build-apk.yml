# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RozgarX AI â€” GitHub Actions APK Builder
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# REQUIRED GitHub Secret (Settings â†’ Secrets â†’ Actions):
#   GOOGLE_SERVICES_JSON  â† paste full content of google-services.json
#
# OPTIONAL Secrets (for signed release APK):
#   KEYSTORE_BASE64   â† base64 encoded .jks keystore file
#   KEY_ALIAS         â† rozgarx
#   KEY_PASSWORD      â† your key password
#   STORE_PASSWORD    â† your store password
#
# TRIGGER: Runs on every push to main, or manually from Actions tab
# OUTPUT:  Download APK from Actions tab â†’ Run â†’ Artifacts section
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: "ðŸš€ Build RozgarX AI APK"

on:
  push:
    branches: [ main, master
  workflow_dispatch:

jobs:
  build:
    name: "Build Android APK"
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:

      - name: "ðŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "â˜• Setup Java 17"
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: "ðŸ¦ Setup Flutter 3.19.6"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.19.6'
          channel: 'stable'
          cache: true

      - name: "âœ… Flutter version check"
        run: |
          flutter --version
          flutter doctor --android-licenses || true

      - name: "ðŸ”‘ Create google-services.json"
        working-directory: mobile
        run: |
          echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > android/app/google-services.json
          echo "google-services.json created âœ…"
          wc -c android/app/google-services.json

      - name: "ðŸ” Setup release keystore (if provided)"
        if: ${{ secrets.KEYSTORE_BASE64 != '' }}
        working-directory: mobile
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/rozgarx-release.jks
          cat > android/key.properties << EOF
          storePassword=${{ secrets.STORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=rozgarx-release.jks
          EOF
          echo "Keystore configured âœ…"

      - name: "ðŸ“ Create required asset folders"
        working-directory: mobile
        run: |
          mkdir -p assets/images assets/animations assets/fonts
          touch assets/images/.gitkeep assets/animations/.gitkeep assets/fonts/.gitkeep
          echo "Assets folders ready âœ…"

      - name: "ðŸ“¦ Flutter pub get"
        working-directory: mobile
        run: |
          flutter pub get
          echo "Packages installed âœ…"

      - name: "ðŸ” Analyze (warnings allowed)"
        working-directory: mobile
        run: flutter analyze --no-fatal-infos || true

      - name: "ðŸ—ï¸ Build Debug APK"
        working-directory: mobile
        run: |
          flutter build apk --debug \
            --target-platform android-arm64
          echo "Debug APK built âœ…"

      - name: "ðŸ—ï¸ Build Release APK (split by CPU)"
        working-directory: mobile
        run: |
          flutter build apk --release \
            --split-per-abi \
            --target-platform android-arm64,android-arm,android-x64
          echo "Release APKs built âœ…"
          echo "--- APK files ---"
          ls -lh build/app/outputs/flutter-apk/

      - name: "ðŸ“Š Get app version"
        id: version
        working-directory: mobile
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | head -1 | sed 's/version: //' | tr -d ' ')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          BUILD_DATE=$(date '+%Y%m%d-%H%M')
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION | Date: $BUILD_DATE"

      - name: "ðŸ“¤ Upload arm64 APK (recommended for most phones)"
        uses: actions/upload-artifact@v4
        with:
          name: "RozgarX-AI-${{ steps.version.outputs.version }}-arm64-release"
          path: mobile/build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          retention-days: 30
          if-no-files-found: error

      - name: "ðŸ“¤ Upload debug APK"
        uses: actions/upload-artifact@v4
        with:
          name: "RozgarX-AI-${{ steps.version.outputs.version }}-debug"
          path: mobile/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30
          if-no-files-found: warn

      - name: "ðŸ“¤ Upload ALL release APK variants"
        uses: actions/upload-artifact@v4
        with:
          name: "RozgarX-AI-${{ steps.version.outputs.version }}-ALL-variants"
          path: mobile/build/app/outputs/flutter-apk/*-release.apk
          retention-days: 30
          if-no-files-found: warn

      - name: "ðŸŽ‰ Build Complete Summary"
        run: |
          echo "## âœ… RozgarX AI APK Build Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| | |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **App Version** | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Date** | ${{ steps.version.outputs.build_date }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± How to install:" >> $GITHUB_STEP_SUMMARY
          echo "1. Scroll down to **Artifacts** section below" >> $GITHUB_STEP_SUMMARY
          echo "2. Download **RozgarX-AI-...-arm64-release** (best for most phones)" >> $GITHUB_STEP_SUMMARY
          echo "3. Unzip â†’ install the .apk on your Android phone" >> $GITHUB_STEP_SUMMARY
