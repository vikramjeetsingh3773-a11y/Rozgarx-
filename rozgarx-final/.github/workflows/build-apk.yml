# ══════════════════════════════════════════════════════════════
# RozgarX AI — GitHub Actions APK Builder
# ══════════════════════════════════════════════════════════════
# REQUIRED GitHub Secret (Settings → Secrets → Actions):
#   GOOGLE_SERVICES_JSON  ← paste full content of google-services.json
#
# TRIGGER: Push to main/master OR manual trigger from Actions tab
# OUTPUT:  Actions tab → click run → Artifacts section → download APK
# ══════════════════════════════════════════════════════════════

name: "Build RozgarX AI APK"

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: "Build Android APK"
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:

      - name: "Checkout code"
        uses: actions/checkout@v4

      - name: "Setup Java 17"
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      - name: "Setup Flutter 3.19.6"
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.6"
          channel: "stable"
          cache: true

      - name: "Verify Flutter"
        run: flutter --version

      - name: "Create google-services.json"
        working-directory: mobile
        env:
          GOOGLE_SERVICES: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          if [ -z "$GOOGLE_SERVICES" ]; then
            echo "ERROR: GOOGLE_SERVICES_JSON secret is not set!"
            echo "Fix: GitHub repo Settings > Secrets > Actions > New secret"
            echo "Name: GOOGLE_SERVICES_JSON"
            echo "Value: paste your google-services.json file content"
            exit 1
          fi
          echo "$GOOGLE_SERVICES" > android/app/google-services.json
          echo "google-services.json created OK"
          wc -c android/app/google-services.json

      - name: "Create asset folders"
        working-directory: mobile
        run: |
          mkdir -p assets/images assets/animations assets/fonts
          touch assets/images/.gitkeep assets/animations/.gitkeep assets/fonts/.gitkeep

      - name: "Flutter pub get"
        working-directory: mobile
        run: flutter pub get

      - name: "Analyze code"
        working-directory: mobile
        run: flutter analyze --no-fatal-infos || true

      - name: "Build Debug APK"
        working-directory: mobile
        run: |
          flutter build apk --debug
          ls -lh build/app/outputs/flutter-apk/app-debug.apk

      - name: "Build Release APK"
        working-directory: mobile
        run: |
          flutter build apk --release --split-per-abi
          ls -lh build/app/outputs/flutter-apk/

      - name: "Get version"
        id: version
        working-directory: mobile
        run: |
          VERSION=$(grep 'version:' pubspec.yaml | head -1 | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: "Upload arm64 release APK"
        uses: actions/upload-artifact@v4
        with:
          name: "RozgarX-AI-arm64-release"
          path: mobile/build/app/outputs/flutter-apk/app-arm64-v8a-release.apk
          retention-days: 30
          if-no-files-found: error

      - name: "Upload debug APK"
        uses: actions/upload-artifact@v4
        with:
          name: "RozgarX-AI-debug"
          path: mobile/build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30
          if-no-files-found: warn

      - name: "Upload all APK variants"
        uses: actions/upload-artifact@v4
        with:
          name: "RozgarX-AI-all-variants"
          path: mobile/build/app/outputs/flutter-apk/*.apk
          retention-days: 30
          if-no-files-found: warn

      - name: "Build Summary"
        run: |
          echo "## RozgarX AI APK Build Complete!" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Built at | $(date '+%Y-%m-%d %H:%M UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| Download | Scroll down to Artifacts section |" >> $GITHUB_STEP_SUMMARY
          
